<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    

    <title>
      MapReduce总结 | Hexo 
    </title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
      <meta name="author" content="Vtamins Lee">
    
    

    <meta name="description" content="做大数据已经有一年了，在这一年中始终没有去好好看看Google的三驾马车，现在回校学习，好好的看看论文，同时也自己做做笔记，记录一下自己的学习过程。 MapReduce作为Google的曾经三驾马车之一，广为大家所知，但是很多人都只知道他能做一些数据处理的工作，并不清楚他其中的原理。这次就让我们来总结一下MapReduce的原理，进行学习。">
<meta name="keywords" content="git">
<meta property="og:type" content="article">
<meta property="og:title" content="MapReduce总结 | Hexo">
<meta property="og:url" content="https://vtamins.github.io/timo/2017/09/12/MapReduce总结/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="做大数据已经有一年了，在这一年中始终没有去好好看看Google的三驾马车，现在回校学习，好好的看看论文，同时也自己做做笔记，记录一下自己的学习过程。 MapReduce作为Google的曾经三驾马车之一，广为大家所知，但是很多人都只知道他能做一些数据处理的工作，并不清楚他其中的原理。这次就让我们来总结一下MapReduce的原理，进行学习。">
<meta property="og:image" content="http://oq6t9jzdc.bkt.clouddn.com/150518467.png">
<meta property="og:image" content="http://oq6t9jzdc.bkt.clouddn.com/150518645.png">
<meta property="og:image" content="http://oq6t9jzdc.bkt.clouddn.com/150518652.png">
<meta property="og:image" content="http://oq6t9jzdc.bkt.clouddn.com/150518689.png">
<meta property="og:image" content="http://oq6t9jzdc.bkt.clouddn.com/150518698.png">
<meta property="og:image" content="http://oq6t9jzdc.bkt.clouddn.com/150518721.png">
<meta property="og:image" content="http://oq6t9jzdc.bkt.clouddn.com/150518730.png">
<meta property="og:updated_time" content="2017-09-13T09:12:56.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MapReduce总结 | Hexo">
<meta name="twitter:description" content="做大数据已经有一年了，在这一年中始终没有去好好看看Google的三驾马车，现在回校学习，好好的看看论文，同时也自己做做笔记，记录一下自己的学习过程。 MapReduce作为Google的曾经三驾马车之一，广为大家所知，但是很多人都只知道他能做一些数据处理的工作，并不清楚他其中的原理。这次就让我们来总结一下MapReduce的原理，进行学习。">
<meta name="twitter:image" content="http://oq6t9jzdc.bkt.clouddn.com/150518467.png">
    
    
    
      <link rel="icon" type="image/x-icon" href="/timo/favicon.png">
    
    <link rel="stylesheet" href="/timo/css/uno.css">
    <link rel="stylesheet" href="/timo/css/highlight.css">
    <link rel="stylesheet" href="/timo/css/archive.css">
    <link rel="stylesheet" href="/timo/css/china-social-icon.css">

</head>
<body>

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    

<header class="panel-cover panel-cover--collapsed">


  <div class="panel-main">

  
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        

        <h1 class="panel-cover__title panel-title"><a href="/timo/" title="link to homepage">Hexo</a></h1>
        <hr class="panel-cover__divider" />

        

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">

              
                
                <li class="navigation__item"><a href="/timo/#blog" title="" class="blog-button">首页</a></li>
              
                
                <li class="navigation__item"><a href="/timo/about" title="" class="">关于</a></li>
              
                
                <li class="navigation__item"><a href="/timo/archive" title="" class="">归档</a></li>
              

            </ul>
          </nav>

          <!-- ----------------------------
To add a new social icon simply duplicate one of the list items from below
and change the class in the <i> tag to match the desired social network
and then add your link to the <a>. Here is a full list of social network
classes that you can use:

    icon-social-500px
    icon-social-behance
    icon-social-delicious
    icon-social-designer-news
    icon-social-deviant-art
    icon-social-digg
    icon-social-dribbble
    icon-social-facebook
    icon-social-flickr
    icon-social-forrst
    icon-social-foursquare
    icon-social-github
    icon-social-google-plus
    icon-social-hi5
    icon-social-instagram
    icon-social-lastfm
    icon-social-linkedin
    icon-social-medium
    icon-social-myspace
    icon-social-path
    icon-social-pinterest
    icon-social-rdio
    icon-social-reddit
    icon-social-skype
    icon-social-spotify
    icon-social-stack-overflow
    icon-social-steam
    icon-social-stumbleupon
    icon-social-treehouse
    icon-social-tumblr
    icon-social-twitter
    icon-social-vimeo
    icon-social-xbox
    icon-social-yelp
    icon-social-youtube
    icon-social-zerply
    icon-mail

-------------------------------->

<!-- add social info here -->



        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>


    <div class="content-wrapper">
        <div class="content-wrapper__inner entry">
            

<article class="post-container post-container--single">

  <header class="post-header">
    
    <h1 class="post-title">MapReduce总结</h1>

    

    <div class="post-meta">
      <time datetime="2017-09-12" class="post-meta__date date">2017-09-12</time> 

      <span class="post-meta__tags tags">

          
            <font class="categories">
            &#8226; 分类:
            <a class="categories-link" href="/timo/categories/大数据/">大数据</a>
            </font>
          

          
             &#8226; 标签:
            <font class="tags">
              <a class="tags-link" href="/timo/tags/git/">git</a>
            </font>
          

      </span>
    </div>
    
    

  </header>

  <section id="post-content" class="article-content post">
    <p>做大数据已经有一年了，在这一年中始终没有去好好看看Google的三驾马车，现在回校学习，好好的看看论文，同时也自己做做笔记，记录一下自己的学习过程。</p>
<p>MapReduce作为Google的曾经三驾马车之一，广为大家所知，但是很多人都只知道他能做一些数据处理的工作，并不清楚他其中的原理。这次就让我们来总结一下MapReduce的原理，进行学习。</p>
<a id="more"></a>
<p>[TOC]</p>
<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>我是一个新闻客户端的负责人，我有一个一大堆的访问日志，但是我现在要对我的访问做优化？</p>
<p>我需要最常访问的页面 TOPN</p>
<p>随意上点日志demo：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">127.0.0.1 - - [22/Jul/2017 23:39:02] &quot;GET /favicon.ico HTTP/1.1&quot; 404 –</div><div class="line"></div><div class="line"></div><div class="line">127.0.0.1 - - [22/Jul/2017 23:39:01] &quot;GET / HTTP/1.1&quot; 200 –</div><div class="line"></div><div class="line"></div><div class="line">127.0.0.1 - - [22/Jul/2017 23:39:01] &quot;GET / HTTP/1.1&quot; 200 –</div></pre></td></tr></table></figure>
<p>好吧，我们用python脚本来试试。大概的处理速度如下：</p>
<p><img src="http://oq6t9jzdc.bkt.clouddn.com/150518467.png" alt=""></p>
<p>速度好像也能接受呀。</p>
<p>那么 0.7TB？</p>
<p><strong>经过计算，时间耗费约18小时</strong></p>
<p>这种时间消耗已经不能够被接受了。</p>
<h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3><p>可有什么比较好的处理思路？</p>
<p><strong>分而治之</strong></p>
<p>mapreduce就是一个不错的分而治之的框架</p>
<h3 id="什么是MapReduce"><a href="#什么是MapReduce" class="headerlink" title="什么是MapReduce"></a>什么是MapReduce</h3><p>目前仍然是大数据的主要处理方式之一</p>
<p>Google用来建立海量数据索引   提高查询速度</p>
<p>最早来自原Lisp语言，Python也有map和reduce。</p>
<h3 id="MapReduce做了什么"><a href="#MapReduce做了什么" class="headerlink" title="MapReduce做了什么"></a>MapReduce做了什么</h3><p>数据分区（HDFS）</p>
<p>计算任务调度</p>
<p>错误处理</p>
<p>机器内部通信管理</p>
<h3 id="一个简单的例子"><a href="#一个简单的例子" class="headerlink" title="一个简单的例子"></a>一个简单的例子</h3><p><code>I have a pen and a apple. You have a pen</code></p>
<p>对于这一段话，我们来统计词频</p>
<p>首先map转化为键值对</p>
<p><code>(I,1),(have,1) ,(a,1) , (pen,1),(and,1) ,(a,1) (apple,1)</code></p>
<p><code>(You,1) , (have,1) , (a,1)  ,( pen,1)</code></p>
<p>reduce收到的数据</p>
<p><code>(I,[1]), (have,[1,1]),(a,[1,1,1]),(pen,[1,1]),(and,[1]),(apple,[1])</code></p>
<p>reduce处理后的数据</p>
<p><code>(I,1), (have,2) , (a,3) , ( pen,2) ,(and,1), (apple,1)</code></p>
<h3 id="处理的过程"><a href="#处理的过程" class="headerlink" title="处理的过程"></a>处理的过程</h3><p><img src="http://oq6t9jzdc.bkt.clouddn.com/150518645.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">map(String key, String value): </div><div class="line"><span class="comment">// key: 文档名</span></div><div class="line"><span class="comment">// value: 文档的内容 </span></div><div class="line"><span class="keyword">for</span> each word w in value:</div><div class="line">    EmitIntermediate(w, <span class="string">"1"</span>);</div><div class="line"><span class="comment">//输出单词与次数的 map</span></div><div class="line"></div><div class="line">reduce(String key, Iterator values): </div><div class="line"><span class="comment">// key: 单词名</span></div><div class="line"><span class="comment">// values: 次数的列表</span></div><div class="line"><span class="keyword">int</span> result = <span class="number">0</span>;</div><div class="line"><span class="keyword">for</span> each v in values:</div><div class="line">     result += ParseInt(v);</div><div class="line">Emit(AsString(result));</div></pre></td></tr></table></figure>
<p>也就是像下面的图所示一样：</p>
<p><img src="http://oq6t9jzdc.bkt.clouddn.com/150518652.png" alt=""></p>
<h3 id="Talk-is-cheap-Show-me-the-code"><a href="#Talk-is-cheap-Show-me-the-code" class="headerlink" title="Talk is cheap.Show me the code!"></a>Talk is cheap.Show me the code!</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Object key, Text value, Context context)</span> </span>&#123;</div><div class="line">        StringTokenizer itr = <span class="keyword">new</span> StringTokenizer(value.toString());</div><div class="line">        <span class="keyword">while</span>(itr.hasMoreTokens()) &#123;</div><div class="line">                word.set(itr.nextToken());</div><div class="line">                context.write(word, one);</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;IntWritable&gt; values, Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> sum = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span>(IntWritable val:values) &#123;</div><div class="line">                sum += val.get();</div><div class="line">        &#125;</div><div class="line">        result.set(sum);</div><div class="line">        context.write(key,result);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>好的，你以为就这么简单就结束了吗？</strong></p>
<p><strong>不，还有一个大的内容没讲。</strong></p>
<p>我们知道map生成了大量的键值对如：</p>
<p><code>(I,1),(have,1) ,(a,1) , (pen,1),(and,1) ,(a,1) (apple,1)</code></p>
<p><code>(You,1) , (have,1) , (a,1)  ,( pen,1)</code></p>
<p>但是reduce收到的却是：</p>
<p><code>(I,[1]), (have,[1,1]),(a,[1,1,1]),(pen,[1,1]),(and,[1]),(apple,[1])</code></p>
<p><strong>WHY？</strong></p>
<h2 id="Shuffle"><a href="#Shuffle" class="headerlink" title="Shuffle"></a>Shuffle</h2><h3 id="什么是shuffle？"><a href="#什么是shuffle？" class="headerlink" title="什么是shuffle？"></a>什么是shuffle？</h3><p>shuffle是MR中一个非常重要的过程，缺了这个过程就不算mapreduce。如何简单的来描述这个过程呢？</p>
<p><strong>上图</strong></p>
<p><img src="http://oq6t9jzdc.bkt.clouddn.com/150518689.png" alt=""></p>
<p>reduce在向map取数据的过程中，做了排序、合并的工作。这个过程真的只是看起来这么简单吗？</p>
<p>让我们一步一步来分析</p>
<h3 id="Map-Shuffle"><a href="#Map-Shuffle" class="headerlink" title="Map Shuffle"></a>Map Shuffle</h3><p><img src="http://oq6t9jzdc.bkt.clouddn.com/150518698.png" alt=""></p>
<p>map阶段的shuffle主要完成了以下工作：</p>
<p><strong>partition</strong></p>
<p>我们有多个reduce，分配到reduce的过程（一般采用Hash）,将map的结果发送到相应的reduce端，总的partition的数目等于reducer的数量。也就在这个阶段去往不同reduce的数据分区了。</p>
<p><strong>spill</strong></p>
<p>什么是spill？内存memory buffer塞满了，要写到磁盘上去，在写入本地磁盘时先按照partition、再按照key进行排序。</p>
<p><strong>combine</strong></p>
<p>执行combine操作要求开发者必须在程序中设置了combine，就会进行一次combine（写之前）如：将 （a，1）  (a,2) 变成 （a,3）</p>
<p><strong>merge</strong></p>
<p>当map很大时，每次溢写会产生一个spill_file，这样会有多个spill_file，而最终的一个map task输出只有一个文件，因此，最终的结果输出之前会对多个中间过程进行多次溢写文件（spill_file）的合并，此过程就是merge过程。</p>
<p>如果生成的文件太多，可能会执行多次合并，每次最多能合并的文件数默认为10，可以通过属性min.num.spills.for.combine配置；</p>
<p>多个溢出文件合并时，会进行一次排序，排序算法是多路归并排序；</p>
<p>是否还需要做combine操作，一是看是否设置了combine，二是看溢出的文件数是否大于等于3；</p>
<p>最终生成的文件格式与单个溢出文件一致，也是按分区顺序存储，并且输出文件会有一个对应的索引文件，记录每个分区数据的起始位置，长度以及压缩长度，这个索引文件名叫做file.out.index。</p>
<h3 id="Reduce-shuffle"><a href="#Reduce-shuffle" class="headerlink" title="Reduce shuffle"></a>Reduce shuffle</h3><p><img src="http://oq6t9jzdc.bkt.clouddn.com/150518721.png" alt=""></p>
<p>作用：拉取数据；</p>
<p>过程：Reduce进程启动一些数据copy线程(Fetcher)，通过HTTP方式请求maptask所在的TaskTracker获取maptask的输出文件。因为这时maptask早已结束，这些文件就归TaskTracker管理在本地磁盘中。</p>
<p>默认情况下，当整个MapReduce作业的所有已执行完成的MapTask任务数超过MapTask总数的5%后，JobTracker便会开始调度执行ReduceTask任务。然后ReduceTask任务默认启动mapred.reduce.parallel.copies(默认为5）个MapOutputCopier线程到已完成的MapTask任务节点上分别copy一份属于自己的数据。这些copy的数据会首先保存的内存缓冲区中，当内冲缓冲区的使用率达到一定阀值后，则写到磁盘上。</p>
<p>Copy过来的数据会先放入内存缓冲区中，这里的缓冲区大小要比map端的更为灵活，它基于JVM的heapsize设置，因为Shuffle阶段Reducer不运行，所以应该把绝大部分的内存都给Shuffle用。</p>
<p>这里需要强调的是，merge有三种形式：</p>
<p>1)内存到内存</p>
<p>2)内存到磁盘</p>
<p>3)磁盘到磁盘。</p>
<p>默认情况下第一种形式是不启用的。当内存中的数据量到达一定阈值，就启动内存到磁盘的merge（图中的第一个merge，之所以进行merge是因为reduce端在从多个map端copy数据的时候，并没有进行sort，只是把它们加载到内存，当达到阈值写入磁盘时，需要进行merge） 。这和map端的很类似，这实际上就是溢写的过程，在这个过程中如果你设置有Combiner，它也是会启用的，然后在磁盘中生成了众多的溢写文件，这种merge方式一直在运行，直到没有map端的数据时才结束，然后才会启动第三种磁盘到磁盘的merge（图中的第二个merge）方式生成最终的那个文件。</p>
<h3 id="Shuffle总结"><a href="#Shuffle总结" class="headerlink" title="Shuffle总结"></a>Shuffle总结</h3><p><img src="http://oq6t9jzdc.bkt.clouddn.com/150518730.png" alt=""></p>
<p>这就是总体的shuffle的过程，发现了什么：</p>
<p><strong>基本就是 分区+排序+合并</strong> </p>
<p>而且在shuffle的过程中发生了大量的<strong>溢写</strong></p>
<p>代表了，在这个过程中产生了大量的磁盘IO操作。这也是造成MR速度慢的原因。要知道，内存比磁盘要快的多。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>MR是一个简单高效的计算模型</li>
<li>基本思想是分而治之</li>
<li>屏蔽了错误处理、任务调度，对用户很友好</li>
</ul>
<p>不足：</p>
<ol>
<li>shuffle的过程中大量的磁盘IO产生，拉低了速度</li>
<li>编程模型的缺陷待我阅读了Spark的论文后再来补上</li>
</ol>

  </section>

  <section class="post-comments">

    <!-- 将评论系统（例如Disqus、多说、友言、畅言等）提供的代码片段粘贴在这里 -->
    
</section>


</article>


            <footer class="footer">

    <span class="footer__copyright">&copy; 2014-2015. | 由<a href="https://hexo.io/">Hexo</a>强力驱动 | 主题<a href="https://github.com/someus/huno">Huno</a></span>
    
</footer>
        </div>
    </div>

    <!-- js files -->
    <script src="/timo/js/jquery.min.js"></script>
    <script src="/timo/js/main.js"></script>
    <script src="/timo/js/scale.fix.js"></script>
    

    

    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript"> 
        $(document).ready(function(){
            MathJax.Hub.Config({ 
                tex2jax: {inlineMath: [['[latex]','[/latex]'], ['\\(','\\)']]} 
            });
        });
    </script>


    

    <script src="/timo/js/awesome-toc.min.js"></script>
    <script>
        $(document).ready(function(){
            $.awesome_toc({
                overlay: true,
                contentId: "post-content",
            });
        });
    </script>


    
    
    <!--kill ie6 -->
<!--[if IE 6]>
  <script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script>
<![endif]-->

</body>
</html>
